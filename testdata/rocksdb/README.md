# RocksDB test fixtures

This directory contains RocksDB-generated fixtures used as the C++ oracle corpus.
The oracle version for these fixtures is RocksDB v10.7.5 (commit 812b12b).

These fixtures are used to verify that our Go implementation produces bit-compatible output with the C++ RocksDB implementation.

## Directory structure

```
rocksdb/
├── v10.7.5/
│   ├── formats/            # Individual-format fixtures (WAL/MANIFEST/CURRENT/OPTIONS/SST slices)
│   │   ├── wal/
│   │   ├── manifest/
│   │   ├── sst/
│   │   ├── CURRENT
│   │   └── options.txt
│   ├── sst_samples/        # Standalone SSTs generated by C++ RocksDB tools
│   └── db_samples/         # Whole DB directories (C++ generated)
└── README.md
```

## Regenerating fixtures

To regenerate fixtures from a fresh RocksDB build:

```bash
# 1) Build RocksDB v10.7.5 tools.
export ROCKSDB_PATH=/path/to/rocksdb
( cd "$ROCKSDB_PATH" && git checkout v10.7.5 && make clean && make shared_lib ldb sst_dump )

# 2) Create a small RocksDB database (C++ oracle).
export DB_PATH=/path/to/rocksdb_test_db
rm -rf "$DB_PATH"
"$ROCKSDB_PATH/ldb" --db="$DB_PATH" --create_if_missing put key1 value1
"$ROCKSDB_PATH/ldb" --db="$DB_PATH" put key2 value2
"$ROCKSDB_PATH/ldb" --db="$DB_PATH" put key3 value3

# 3) Copy the generated files into this repository (run from the repo root).
cp "$DB_PATH"/*.log ./testdata/rocksdb/v10.7.5/formats/wal/
cp "$DB_PATH"/MANIFEST-* ./testdata/rocksdb/v10.7.5/formats/manifest/
cp "$DB_PATH"/*.sst ./testdata/rocksdb/v10.7.5/formats/sst/
```

## Fixture details

### WAL files
- `simple.log`: Single WriteBatch with seq=3, key3=value3 (32 bytes)
- `multi.log`: Single WriteBatch with seq=5, key5=value5 (32 bytes)
- `fragmented.log`: Large record ~50KB that spans multiple 32KB blocks

### MANIFEST files
- `simple.manifest`: Multiple VersionEdits including:
  - Comparator: leveldb.BytewiseComparator
  - LogNumber updates
  - NextFileNumber updates
  - LastSequence updates
  - NewFile4 entries for key1 and key2

- `newfile.manifest`: More complex VersionEdits with multiple NewFile4 entries:
  - Files for key1, key2, key3, key4
  - Compaction moving key1 to level 6

### SST files

- `simple.sst`: A small block-based table produced by RocksDB tools for format compatibility testing.

## Usage in tests

Golden tests read these files and verify:
1. Our WAL reader can parse C++-generated WAL files
2. Our VersionEdit decoder can parse C++-generated MANIFEST files
3. Round-trip: encode -> decode produces identical results

```go
func TestGoldenWALSimple(t *testing.T) {
    data, _ := os.ReadFile("testdata/rocksdb/v10.7.5/formats/wal/simple.log")
    reader := wal.NewReader(bytes.NewReader(data), nil, true, 0)
    record, err := reader.ReadRecord()
    // verify record contains expected data
}
```
