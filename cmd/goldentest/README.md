# Golden Compatibility Tests

Verifies bit-level compatibility between RockyardKV (Go) and RocksDB (C++).
This directory is part of the test tooling and not part of the API.

> [!NOTE]
> **Philosophy:** “C++ tools are the oracle; tests skip if missing.”

## Prerequisites

### 1. Install compression libraries

On macOS (Homebrew):
```bash
brew install snappy lz4 zstd
```

On Linux (Debian/Ubuntu):
```bash
sudo apt install libsnappy-dev liblz4-dev libzstd-dev
```

### 2. Build RocksDB tools

> [!NOTE]
> RocksDB’s C++ tools act as the oracle for format verification. If the tools aren’t present, tests that require them will skip.

```bash
cd /path/to/rocksdb

# Clean any previous build
make clean

# Set paths for compression libraries (macOS Homebrew)
export CPATH=/opt/homebrew/include
export LIBRARY_PATH=/opt/homebrew/lib

# Build with compression support
make -j8 USE_RTTI=1 DEBUG_LEVEL=0 LIB_MODE=shared tools
```

Verify the build includes compression:
```bash
grep -E "SNAPPY|LZ4|ZSTD" make_config.mk
# Should show: -DSNAPPY -DLZ4 -DZSTD
```

## Running tests

```bash
# Set library path for compression libs (macOS)
ROCKSDB_DEPS_LIBDIR=/opt/homebrew/lib go test -v ./cmd/goldentest/...

# Linux (usually not needed if libs are in standard paths)
go test -v ./cmd/goldentest/...
```

Some tests require C++ tools. If `sst_dump` or `ldb` are not found, those tests skip.

## Package structure

```
cmd/goldentest/
├── sst_format_test.go      # Format version × compression matrix
├── sst_contract_test.go    # Behavioral contracts (edge cases)
├── sst_test.go             # C++ fixture tests, sst_dump features
├── db_test.go              # Database compatibility tests
├── wal_test.go             # WAL format tests
├── manifest_test.go        # MANIFEST format tests
├── constants_test.go       # Magic numbers, property names
├── testdata/
│   ├── cpp_generated/      # Fixtures generated by C++ RocksDB
│   └── go_generated/       # Fixtures generated by Go (output)
└── README.md
```

## Test categories

### SST tests

| File | Purpose |
|------|---------|
| `sst_format_test.go` | Format versions (V3–V6), compression types |
| `sst_contract_test.go` | Edge cases: binary keys, deletions, large values |
| `sst_test.go` | C++ fixtures, `sst_dump --verify_checksum` |

### Database tests (`db_test.go`)

- Go round-trip (write, read, reopen)
- Column family isolation
- Go ↔ C++ compatibility

### WAL tests (`wal_test.go`)

- Go writes WAL, C++ reads database
- Go reads C++ WAL fixtures

### MANIFEST tests (`manifest_test.go`)

- Go reads C++ MANIFEST
- Unknown tags preserved (Issue 1)
- Corruption rejected (Issues 5+6)

### Constant tests (`constants_test.go`)

- Magic numbers match C++
- Property names match C++
- Footer sizes match C++

## Adding new tests

1. Choose the appropriate file based on what you're testing
2. Write a `Test*` function following Go testing conventions
3. Use `t.Skip()` if C++ tools are required but not found
4. Run `go test -v ./cmd/goldentest/...` to verify

## Troubleshooting

### `signal: abort trap` or `Library not loaded`

The C++ tools can't find dynamic libraries. Set the library path:
```bash
ROCKSDB_DEPS_LIBDIR=/opt/homebrew/lib go test ./cmd/goldentest/...
```

### `Not implemented: Snappy/LZ4/ZSTD not supported in this build`

RocksDB was built without compression support. Rebuild with:
```bash
export CPATH=/opt/homebrew/include LIBRARY_PATH=/opt/homebrew/lib
make -j8 USE_RTTI=1 DEBUG_LEVEL=0 LIB_MODE=shared tools
```

### `Symbol not found` C++ ABI errors

The RocksDB dylib was built with an incompatible C++ standard library.
Clean rebuild usually fixes this:
```bash
make clean && make -j8 USE_RTTI=1 DEBUG_LEVEL=0 LIB_MODE=shared tools
```

## Reference

- RocksDB v10.7.5 (commit `812b12b`) — used for oracle tooling + fixture generation
- `tools/ldb.cc`
- `tools/sst_dump.cc`

<!-- DO NOT REMOVE ATTRIBUTION SECTION -->
## Provenance / Attribution

The files under `golden/v10.7.5/` are generated data fixtures created using the
official RocksDB tools (e.g., `ldb`) from RocksDB `v10.7.5` (commit `812b12b`) for
the purpose of interoperability testing.

These fixtures are data artifacts, not copied RocksDB source code. RocksDB is a
separately licensed project; see the repository's license for details.
