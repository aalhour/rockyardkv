# Golden Test Framework

This package verifies bit-level compatibility between RockyardKV (Go) and RocksDB (C++).

## Prerequisites

1. Build the RocksDB tools (ldb and sst_dump):

   ```bash
   cd /path/to/rocksdb
   make ldb sst_dump
   ```

2. Generate C++ fixtures:

   ```bash
   ./generate_fixtures.sh
   ```

## Package structure

Tests are organized by **topic** (component being tested):

```
cmd/goldentest/
├── main.go               # CLI test runner and orchestration
├── sst_verify.go         # SST file format tests (CLI)
├── sst_test.go           # SST file format tests (Go tests)
├── wal_verify.go         # WAL file format tests (CLI)
├── manifest_verify.go    # MANIFEST file format tests (CLI)
├── block_verify.go       # Block format tests (CLI)
├── compression_verify.go # Compression algorithm tests (CLI)
├── db_verify.go          # Full database tests (CLI)
├── constants_test.go     # Constant verification (Go tests)
├── generate_fixtures.sh  # Script to generate C++ fixtures
├── run_tests.sh          # Script to run all tests
├── README.md             # This file
└── testdata/
    ├── cpp_generated/    # Fixtures generated by C++ RocksDB
    └── go_generated/     # Fixtures generated by Go RockyardKV
```

Each topic file contains tests for that component across all directions:
- Go writes, C++ reads
- C++ writes, Go reads  
- Go writes, Go reads (round-trip)

## Running tests

### Go tests (quick feedback)

```bash
go test -v ./cmd/goldentest/...
```

Runs `*_test.go` files for SST compatibility and constant verification.

### CLI tool (full verification)

```bash
go run ./cmd/goldentest \
  -fixtures ./cmd/goldentest/testdata/cpp_generated \
  -output ./cmd/goldentest/testdata/go_generated \
  -ldb /path/to/rocksdb/ldb \
  -sst-dump /path/to/rocksdb/sst_dump \
  -v
```

### Command-line flags

| Flag | Description |
| --- | --- |
| `-fixtures` | Directory containing C++-generated fixtures (required) |
| `-output` | Directory to write Go-generated fixtures (required) |
| `-ldb` | Path to RocksDB `ldb` binary |
| `-sst-dump` | Path to RocksDB `sst_dump` binary |
| `-v` | Verbose output |

## Test categories

### SST tests (`sst_verify.go`, `sst_test.go`)

- Go reads C++ SST files
- C++ reads Go-generated SST files
- Checksum verification
- Multiple block sizes
- Compression variants
- Binary keys, empty values, large values
- Deletion markers, sequence numbers

### WAL tests (`wal_verify.go`)

- Go writes WAL, C++ reads database

### MANIFEST tests (`manifest_verify.go`)

- Go reads C++ MANIFEST
- Unknown tags preserved (Issue 1 fix)
- Corrupted MANIFEST rejected (Issues 5+6 fix)

### Block tests (`block_verify.go`)

- Block format verified via SST reading

### Compression tests (`compression_verify.go`)

- Raw deflate (zlib) compatible with RocksDB (Issue 8 fix)

### Database tests (`db_verify.go`)

- Go opens C++ database
- C++ opens Go-generated database
- Column family isolation (Issue 7 fix)

### Constant tests (`constants_test.go`)

- Magic numbers match C++
- Property names match C++
- Footer sizes match C++
- Checksum types match C++

## Adding new tests

1. Identify the topic (SST, WAL, MANIFEST, etc.)
2. Add the test to the appropriate `*_verify.go` (CLI) or `*_test.go` (Go test) file
3. For CLI tests, register in the corresponding `run*Tests()` function in `main.go`

## Reference

- RocksDB v10.7.5 (commit 812b12b)
- `tools/ldb.cc`
- `tools/sst_dump.cc`
