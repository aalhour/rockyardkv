# Golden Test Framework

This tool verifies bit-level compatibility between RockyardKV (Go) and RocksDB (C++).

## Prerequisites

1. Build the RocksDB tools (ldb and sst_dump):

   ```bash
   cd /path/to/rocksdb
   make ldb sst_dump
   ```

2. Generate C++ fixtures:

   ```bash
   ./generate_fixtures.sh
   ```

## Running tests

Run all golden tests:

```bash
go run ./cmd/goldentest \
  -fixtures ./cmd/goldentest/testdata/cpp_generated \
  -output ./cmd/goldentest/testdata/go_generated \
  -ldb /path/to/rocksdb/ldb \
  -sst-dump /path/to/rocksdb/sst_dump \
  -v
```

### Command-line flags

| Flag | Description |
| --- | --- |
| `-fixtures` | Directory containing C++-generated fixtures (required) |
| `-output` | Directory to write Go-generated fixtures (required) |
| `-ldb` | Path to RocksDB `ldb` binary |
| `-sst-dump` | Path to RocksDB `sst_dump` binary |
| `-v` | Verbose output |

## Test categories

Each category has its own verification file.

### WAL format tests (`wal_verify.go`)

Verify Write-Ahead Log format compatibility.

- Go writes WAL, C++ reads database

### MANIFEST format tests (`manifest_verify.go`)

Verify MANIFEST (VersionEdit) format compatibility.

- Go reads C++ MANIFEST
- MANIFEST unknown tags readable by C++ (Issue 1 fix)
- Corrupted MANIFEST rejected by both Go and C++ (Issues 5+6 fix)

### Block format tests (`block_verify.go`)

Verify data block format compatibility.
Block format is tested implicitly through SST file reading.

### SST format tests (`sst_verify.go`)

Verify SSTable file format compatibility.

- Go reads C++ SST files
- C++ reads Go-generated SST

### Compression format tests (`compression_verify.go`)

Verify compression algorithm compatibility.

- Raw deflate (zlib) compatible with RocksDB (Issue 8 fix)

### Full database tests (`db_verify.go`)

Verify complete database compatibility.

- Go opens C++ database
- C++ opens Go-generated database
- C++ reads Go column families (Issue 7 fix)

## Package structure

```
cmd/goldentest/
├── main.go                 # Test runner and orchestration
├── wal_verify.go           # WAL format tests
├── manifest_verify.go      # MANIFEST format tests
├── block_verify.go         # Block format tests
├── sst_verify.go           # SST format tests
├── compression_verify.go   # Compression format tests
├── db_verify.go            # Full database tests
├── generate_fixtures.sh    # Script to generate C++ fixtures
├── run_tests.sh            # Script to run all tests
├── README.md               # This file
└── testdata/
    ├── cpp_generated/      # Fixtures generated by C++ RocksDB
    │   ├── block/
    │   ├── manifest/
    │   ├── sst/
    │   └── wal/
    └── go_generated/       # Fixtures generated by Go RockyardKV
```

## Fixture generation

C++ fixtures are generated using the RocksDB tools.
The `generate_fixtures.sh` script creates:

- WAL files with various record types
- MANIFEST files with different VersionEdit configurations
- Data blocks with prefix compression
- Complete SST files from a test database

Go fixtures are generated during test runs and stored in `testdata/go_generated/`.

## Adding new tests

1. Identify the appropriate category file (or create a new one).
2. Add a verification function following the naming pattern:
   - `verifyGoReads*` for Go reading C++ output
   - `verify*GeneratesX` for Go generating output C++ reads
3. Register the test in the corresponding `run*Tests()` function in `main.go`.
4. Update this README with the new test.

## Reference

- RocksDB v10.7.5 (commit 812b12b)
- `tools/ldb.cc`
- `tools/sst_dump.cc`
