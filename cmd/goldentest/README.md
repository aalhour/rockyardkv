# Golden Test Framework

Verifies bit-level compatibility between RockyardKV (Go) and RocksDB (C++).

## Prerequisites

Build the RocksDB tools (ldb and sst_dump):

```bash
cd /path/to/rocksdb
make ldb sst_dump
```

## Running tests

```bash
go test -v ./cmd/goldentest/...
```

Some tests require C++ tools. If `sst_dump` or `ldb` are not found, those tests skip.

## Package structure

```
cmd/goldentest/
├── sst_format_test.go      # Format version × compression matrix
├── sst_contract_test.go    # Behavioral contracts (edge cases)
├── sst_test.go             # C++ fixture tests, sst_dump features
├── db_test.go              # Database compatibility tests
├── wal_test.go             # WAL format tests
├── manifest_test.go        # MANIFEST format tests
├── constants_test.go       # Magic numbers, property names
├── testdata/
│   ├── cpp_generated/      # Fixtures generated by C++ RocksDB
│   └── go_generated/       # Fixtures generated by Go (output)
└── README.md
```

## Test categories

### SST tests

| File | Purpose |
|------|---------|
| `sst_format_test.go` | Format versions (V3–V6), compression types |
| `sst_contract_test.go` | Edge cases: binary keys, deletions, large values |
| `sst_test.go` | C++ fixtures, `sst_dump --verify_checksum` |

### Database tests (`db_test.go`)

- Go round-trip (write, read, reopen)
- Column family isolation
- Go ↔ C++ compatibility

### WAL tests (`wal_test.go`)

- Go writes WAL, C++ reads database
- Go reads C++ WAL fixtures

### MANIFEST tests (`manifest_test.go`)

- Go reads C++ MANIFEST
- Unknown tags preserved (Issue 1)
- Corruption rejected (Issues 5+6)

### Constant tests (`constants_test.go`)

- Magic numbers match C++
- Property names match C++
- Footer sizes match C++

## Adding new tests

1. Choose the appropriate file based on what you're testing
2. Write a `Test*` function following Go testing conventions
3. Use `t.Skip()` if C++ tools are required but not found
4. Run `go test -v ./cmd/goldentest/...` to verify

## Reference

- RocksDB v10.7.5 (commit 812b12b)
- `tools/ldb.cc`
- `tools/sst_dump.cc`
